FROM os/ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# 1. 安装 Ubuntu 24.04 自带的 Python 3.12
# 注意：每个 RUN 指令中的 \ 后面不能有空格或注释
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-dev \
        python3-venv \
        python3-full \
        curl \
        gcc \
        g++ \
        make \
        libssl-dev \
        libffi-dev \
        ca-certificates && \
    ln -sf /usr/bin/python3 /usr/bin/python && \
    python3 --version && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 2. 安装 Poetry
RUN pip3 install poetry && \
    poetry --version

ENV PATH="/root/.local/bin:$PATH"

WORKDIR /app

# 3. 复制项目文件
COPY pyproject.toml README.md ./

# 4. 配置 Poetry 环境
RUN poetry config virtualenvs.create false

# 5. 修正 Python 版本约束（如果需要）
RUN if grep -q ">=3.12,<4.0" pyproject.toml; then sed -i 's/>=3.12,<4.0/>=3.12,<3.14/' pyproject.toml; fi

# 6. 安装依赖
RUN poetry install --no-interaction

# 7. 验证
RUN echo "构建完成！" && \
    echo "Python 版本:" && python --version && \
    echo "Poetry 版本:" && poetry --version
    
